# Multi-label semantic segmentation of magnetic resonance images of the prostate gland

## Author: Mark Locherer

### Cite this work

If you find this work useful and use it for your own project please cite the following work: [Multiâ€‘label semantic segmentation of magnetic resonance images of the prostate gland](https://doi.org/10.1007/s44163-024-00162-z)

### DOI for the source code

[![DOI](https://zenodo.org/badge/DOI/10.5281/zenodo.11108534.svg)](https://doi.org/10.5281/zenodo.11108534)


### Directories and files

subdirectory ```pymodules``` contains:
- datasets (all files starting with ds)
- plotting functions for datasets in DsI2CVB.py
- Lossfunctions
- models UNet, UNetSlim (UNetS)
- utils for training
- ```ds_paths.py``` contains all the paths to the datasets and runs. The run folder contains all model files and pickle files for each dataset and stage combination.

main directory contains training and evaluation files:

- hyperparameter testing
- 5-fold cross validation
- read and run models locally to evaluate the results and create images
- ```s``` indicates the stage: sometimes also ```unet``` is used. The subsequent number the stage id.

### Model- and configuration files

The model was trained in 5cv fashion. Thus 5 models exist for each fold and one configuration file.

#### model files

```<stage#>_<dataset>_<histogram eq>_5cv_f<fold number>.pt```, 
e.g.:
1. unet1_combined_clahe_5cv_f0.pt
2. unet1_combined_clahe_5cv_f1.pt
3. unet1_combined_clahe_5cv_f2.pt
4. unet1_combined_clahe_5cv_f3.pt
5. unet1_combined_clahe_5cv_f4.pt

The same exists for stage 2 and 3 and for the I2CVB and UDE prostate dataset.

#### Configuration file

 The file:
```<stage#>_<dataset>_<histogram eq>_5cv.pickle```, e.g. ```unet1_combined_clahe_5cv.pickle``` (unet1, trained on combined dataset, with clahe), contains all the information on how the model was trained on.

There ```.pickle```-file contains a dict (here: ```x```) with the following format:
- ```x``` 
  - ```'folds'```: number of folds 
  - ```'runs'```
    - ```'0'```: first run results
      - ```'train_patients_li'```: list with all patients that were used for training
      - ```'test_patients_li'```: list with all patients that were used for testing
      - ```'best_val_model_fpath'```: filename of the model with best performance
      - ```'best_train_loss'```: train loss achieved
      - ```'best_train_epoch'```: in epoch
      - ```'train_loss_list'```: all the training losses over all batches and epochs
      - ```'best_val_loss'```: val loss achieved
      - ```'best_val_epoch```: in epoch
      - ```'train_loss_list'```: all the validation losses over all batches and epochs
      - ```'conf_matr_list'```: list with all confusion matrices over all batches in the best epoch obviously for the test_patients_li
      - ```'duration_total'```: training duration in sec 
    - ```'1'```: 2nd run results
    - ... 
    - ```'4'```: 5th run results

### To get started

1. Install all required dependencies.
2. Install the datasets and convert them to the correct format.
3. go to file ```source/pymodules/ds_paths.py``` and add the correct paths.
   1. Add dataset paths
   2. Add model paths
4. Run ```source/Casc-UNet.py```

### Training and evaluation

1. run s<#>_hpt_train_eval.py -> copy and extract hyperparameters
2. run s<#>_kcv_train_eval.py -> 5cv train + eval
3. run s<#>_kcv_eval.py -> local evaluation with filter and stage connections

all files contain different switches and configurations. you have to read the docs and play around to better understand
them what was done.

### Datasets

Watch out there are three different datasets:

1. I2CVB (bg, cap, pz, cg, cap) (https://i2cvb.github.io/)
2. UDE from Uni Duisburg-Essen (bg, cap, pz, cg (generated), les) ([UDEp download instructions](https://github.com/MLocherer/UDE-prostate_raw))
3. combined which includes both. (bg, cap, pz, cg, les)

File ```source/pymodules/ds_ude_mitk_process.py``` contains:

- UDE dataset does not contain the cg class. This class is automatically generated by an algorithm.
- the function ```mitk_process``` which can be used to import MITK files. You need to install and configure The Medical
  Imaging Interaction Toolkit (MITK) from mitk.org

### Dependencies

The following packages must be installed using python version 3.7:

- conda install -c simpleitk simpleitk
- optional (conda install -c conda-forge opencv) does not work with pytorch
- conda install pytorch torchvision torchaudio cudatoolkit=11.1 -c pytorch -c nvidia
- conda install -c anaconda scikit-learn
- conda install -c anaconda scikit-image
- conda install -c anaconda natsort
- conda install -c conda-forge tabulate
- conda install -c anaconda seaborn 

### Results

<table>
    <caption>Average and standard deviation in () in % for 3D-volume- and slice-based DSC results for
Casc-UNetS in the different prostate zones.</caption>
    <thead>
        <tr>
            <th></th>
            <th>dataset</th>
            <th>i2cvb [%]</th>
            <th></th>
            <th>ude [%]</th>
            <th></th>
            <th>combined [%]</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>region</td>
            <td>zone</td>
            <td>3D</td>
            <td>slice</td>
            <td>3D</td>
            <td>slice</td>
            <td>3D</td>
            <td>slice</td>
        </tr>
    <tr>
        <td>complete</td>
        <td>wg</td>
        <td>90.6(2.5)</td>
        <td>89.2(9.7)</td>
        <td>86.5(14.9)</td>
        <td>81.8(22.0)</td>
        <td>88.1(11.8)</td>
        <td>84.5(18.8)</td>
    </tr>
    <tr>
        <td></td>
        <td>pz</td>
        <td>66.6(10.5)</td>
        <td>65.4(17.5)</td>
        <td>70.0(15.0)</td>
        <td>59.1(31.4)</td>
        <td>68.9(11.7)</td>
        <td>62.0(26.3)</td>
    </tr>
    <tr>
        <td></td>
        <td>cg</td>
        <td>75.0(18.6)</td>
        <td>70.5(30.4)</td>
        <td>80.9(15.7)</td>
        <td>76.6(22.5)</td>
        <td>78.7(16.8)</td>
        <td>74.7(25.2)</td>
    </tr>
    <tr>
        <td></td>
        <td>cap</td>
        <td>34.5(26.2)</td>
        <td>28.8(31.0)</td>
        <td>21.0(19.2)</td>
        <td>14.3(24.1)</td>
        <td>22.1(20.7)</td>
        <td>18.2(26.3)</td>
    </tr>
    </tbody>
</table>
